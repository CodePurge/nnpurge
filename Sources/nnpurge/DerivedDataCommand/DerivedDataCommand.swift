//
//  DerivedDataCommand.swift
//  Nnpurge
//
//  Created by Nikolai Nobadi on 10/26/25.
//

import Foundation
import CodePurgeKit
import ArgumentParser

extension Nnpurge {
    struct DerivedDataCommand: ParsableCommand {
        static let configuration = CommandConfiguration(
            commandName: "derived-data",
            abstract: "Manage derived data generated by Xcode",
            subcommands: [
                Delete.self,
                Path.self,
                Open.self
            ]
        )
    }
}


// MARK: - Delete
extension Nnpurge.DerivedDataCommand {
    struct Delete: ParsableCommand {
        static let configuration = CommandConfiguration(
            abstract: "Deletes derived data generated by Xcode"
        )
        
        @Flag(name: .shortAndLong, help: "Deletes all derived data folders.")
        var all: Bool = false
        
        func run() throws {
            try Nnpurge.makeDerivedDataController().deleteDerivedData(deleteAll: all)
        }
    }
}


// MARK: - Path
extension Nnpurge.DerivedDataCommand {
    struct Path: ParsableCommand {
        static let configuration = CommandConfiguration(
            abstract: "View or set the derived data folder path"
        )

        @Option(name: .shortAndLong, help: "Set a custom path for the derived data folder.")
        var set: String?

        @Flag(name: .shortAndLong, help: "Reset to the default derived data path.")
        var reset: Bool = false

        func run() throws {
            let controller = Nnpurge.makeDerivedDataController()
            let message = controller.managePath(set: set, reset: reset)
            
            print(message)
        }
    }
}


// MARK: - Open
extension Nnpurge.DerivedDataCommand {
    struct Open: ParsableCommand {
        static let configuration = CommandConfiguration(
            abstract: "Open the derived data folder in Finder"
        )

        func run() throws {
            try Nnpurge.makeDerivedDataController().openDerivedDataFolder()
            print("Opening derived data folder...")
        }
    }
}


// MARK: - Extension Dependencies
private extension Nnpurge {
    static func makeDerivedDataController() -> DerivedDataController {
        let picker = Nnpurge.makePicker()
        let store = Nnpurge.makeUserDefaults()
        let progressHandler = ConsoleProgressBar()
        let service = Nnpurge.makeDerivedDataService(path: store.loadDerivedDataPath())

        return .init(store: store, picker: picker, service: service, progressHandler: progressHandler)
    }
}
